# History of page writeback / flusher
[Dynamic writeback throttling](https://lwn.net/Articles/405076/)
## pdflush
Professional Linux kernel architecture.
[LINUX缓存写回机制](http://oenhan.com/linux-cache-writeback)
## bdi_writeback
[Linux内核延迟写机制 - ilinuxkernel](http://www.ilinuxkernel.com/files/Linux.Kernel.Delay.Write.pdf)
Scalability of multiple disks 
[In defense of per-BDI writeback](https://lwn.net/Articles/354851/)
[Flushing out pdflush](https://lwn.net/Articles/326552/)
[Per backing device writeback jens axboe](https://blog.linuxplumbersconf.org/2009/slides/Jens-Axboe-lpc2009-slides-axboe.pdf)
[Explaination from Jens on LPC 2009](https://blog.linuxplumbersconf.org/ocw/proposals/22)
[kernelnewbies Per-backing-device based writeback](https://kernelnewbies.org/Linux_2_6_32#Per-backing-device_based_writeback)
## cmwq delayed work and [writback rescuer](http://www.wowotech.net/irq_subsystem/cmwq-intro.html)
Linux 技术内幕
[writeback: convert writeback to unbound workqueue](https://groups.google.com/forum/#!topic/fa.linux.kernel/OnsAP-Zy-s8)
[Toward less-annoying background writeback](https://lwn.net/Articles/682582/)
default_bdi_init->alloc_workqueue("writeback", WQ_MEM_RECLAIM...)
mm/backing-dev.c
mm/page-writeback.c
bdi->wb_list
### Core function
wb_workfn
### Queue wb work
wb_queue_work
wb_wakeup
wb_wakeup_delayed

# Page flags
PG_writeback, lost in past;
set_page_writeback

# Page frame reclamation ??
shrink_inactive_list->wakeup_flusher_threads(WB_REASON_VMSCAN) ?
WB_REASON_FREE_MORE_MEM: no use it; [buffer: eliminate the need to call free_more_memory() in __getblk_slow()](https://patchwork.kernel.org/patch/9974719/)

# sync, fsync, fdatasync -- seems irrevelant
fs/sync.c
syncfs
sync_inodes_sb
writeback_inodes_sb(sb, WB_REASON_SYNC)
sys_sync-> ksys_sync
vfs_fsync_range -> ext2_fsync->generic_file_fsync
{
	file_write_and_wait_range->write_pages/write_page->block_write_full_page->submit_bh_wbc->submit_bio
	or
	blkdev_issue_flush -> submit_bio_wait
}

# Write
generic_perform_write->balance_dirty_pages_ratelimited
domain_dirty_limits
/proc/sys/vm/dirty_background_bytes  
/proc/sys/vm/dirty_bytes

# Fault
wp_page_shared and do_shared_fault
fault_dirty_shared_page->balance_dirty_pages_ratelimited
domain_dirty_limits
/proc/sys/vm/dirty_background_bytes  
/proc/sys/vm/dirty_bytes

# Periodic - time
/proc/sys/vm/dirty_expire_centisecs 
/proc/sys/vm/dirty_writeback_centisecs
dirty_writeback_centisecs_handler -> wakeup_flusher_threads(WB_REASON_PERIODIC)
wb_workfn->wb_do_writeback->wb_check_old_data_flush...->bio
and 
        else if (wb_has_dirty_io(wb) && dirty_writeback_interval)
                wb_wakeup_delayed(wb);

# Periodic - ratio
fs/fs-writeback.c
wb_workfn->wb_do_writeback->wb_check_background_flush->wb_over_bg_thresh
and 
        else if (wb_has_dirty_io(wb) && dirty_writeback_interval)
                wb_wakeup_delayed(wb);

/proc/sys/vm/dirty_background_ratio 
/proc/sys/vm/dirty_ratio 
domain_dirty_limits
/proc/sys/vm/dirty_background_bytes  
/proc/sys/vm/dirty_bytes

# Congestion
inode_write_congested
PGDAT_WRITEBACK,

# Write
 => __block_write_full_page
 => __writepage
 => write_cache_pages
 => generic_writepages
 => do_writepages
 => __filemap_fdatawrite_range
 => iterate_bdevs
 => ksys_sync

[root@snow tracing]# grep wb_writeback trace | wc -l
518
[root@snow tracing]# grep __block_write_full_ trace | wc -l
1036
 => __block_write_full_page
 => __writepage
 => write_cache_pages
 => generic_writepages
 => do_writepages
 => __writeback_single_inode
 => writeback_sb_inodes
 => __writeback_inodes_wb
 => wb_writeback
 => wb_workfn
or
 => blkdev_writepage
 => __writepage
 => write_cache_pages
 => generic_writepages
 => do_writepages
 => __writeback_single_inode
 => writeback_sb_inodes
 => __writeback_inodes_wb
 => wb_writeback
# wb_check_background_flush or  wb_check_old_data_flush  or wb_check_start_all
 => wb_workfn


# IO completetion hanlder
[root@snow tracing]# grep block_write_full_page trace | wc -l 
484
[root@snow tracing]# grep wb_workfn trace | wc -l 
242
10474  => end_page_writeback
10475  => __block_write_full_page
10476  => __writepage
10477  => write_cache_pages
10478  => generic_writepages
10479  => do_writepages
10480  => __writeback_single_inode
10481  => writeback_sb_inodes
10482  => __writeback_inodes_wb
10483  => wb_writeback
10484  => wb_workfn

10720  => end_page_writeback	# Parent should be end_buffer_async_write
10721  => end_bio_bh_io_sync	# submit_bh_wbc
10722  => blk_update_request
10723  => scsi_end_request
10724  => scsi_io_completion
10725  => blk_done_softirq

  793  => end_page_writeback
  794  => ext4_finish_bio
  795  => ext4_end_bio		# io_submit_init_bio
  796  => blk_update_request
  797  => scsi_end_request
  798  => scsi_io_completion
  799  => blk_done_softirq

 => end_buffer_async_write
 => end_bio_bh_io_sync
 => blk_update_request
 => scsi_end_request
 => scsi_io_completion
 => blk_done_softirq
# ETC
writeback代码分析 and cgroup http://kernel.pursuitofcloud.org/713974
Writeback and control groups https://lwn.net/Articles/648292/
writeback visibility writeback visibility
node_dirty_ok
writeback_set_ratelimit
global_dirty_limits
/sys/kernel/debug/bdi/0\:80/stats 
bdi_debug_stats_show
write_begin and write_end
